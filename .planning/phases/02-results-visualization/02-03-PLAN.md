---
phase: 02-results-visualization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [components/CalculationDetails.tsx, components/ComparisonView.tsx, app/page.tsx]
autonomous: true

must_haves:
  truths:
    - "User can expand section to view calculation methodology"
    - "User can see all parafiscal rates used"
    - "User can see formulas applied"
    - "User can see assumptions and constraints"
  artifacts:
    - path: "components/CalculationDetails.tsx"
      provides: "Expandable calculation transparency section"
      min_lines: 60
      contains: "useState"
    - path: "components/ComparisonView.tsx"
      provides: "Enhanced comparison with details integration"
  key_links:
    - from: "CalculationDetails.tsx"
      to: "constants/parafiscales.ts"
      via: "displays rates from constants"
      pattern: "import.*HEALTH_RATE|PENSION_RATE|ARL_RATES"
    - from: "ComparisonView.tsx"
      to: "CalculationDetails.tsx"
      via: "renders expandable section"
      pattern: "<CalculationDetails"
---

<objective>
Add expandable section showing calculation methodology for transparency and credibility.

Purpose: Build trust with clients by showing exact formulas, rates, and assumptions used in savings calculations.
Output: Collapsible section displaying all calculation details (rates, formulas, assumptions).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

Existing constants and types:
@lib/constants/parafiscales.ts
@types/scenarios.ts

Current comparison view:
@components/ComparisonView.tsx
@components/ScenarioCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create expandable calculation details component</name>
  <files>components/CalculationDetails.tsx</files>
  <action>
    Create CalculationDetails component:
    - Accept arlRiskLevel prop (ARLRiskLevel)
    - Use useState for expand/collapse toggle
    - Import all rates from lib/constants/parafiscales.ts (HEALTH_RATE, PENSION_RATE, ARL_RATES, SENA_RATE, ICBF_RATE, CAJA_RATE)

    Structure:
    1. **Expandable header button** (Click to expand/collapse):
       - Text: "Ver metodología de cálculo" when collapsed
       - Text: "Ocultar metodología" when expanded
       - Icon: chevron down/up
       - Tailwind: cursor-pointer, hover:bg-gray-100

    2. **Expandable content** (hidden when collapsed):
       - **Tasas de Parafiscales** section:
         - Salud: 8.5%
         - Pensión: 12%
         - ARL: {dynamically show rate for selected risk level}
         - SENA: 2%
         - ICBF: 3%
         - Caja Compensación: 4%
         - Total: {sum of all rates}

       - **Fórmulas Aplicadas** section:
         - "Parafiscales Tradicionales = Base Salarial × (Σ Tasas)"
         - "Parafiscales Tikin = Base Salarial Reducida × (Σ Tasas)"
         - "Ahorro = Parafiscales Tradicionales - Parafiscales Tikin"
         - "Porcentaje de Reducción = (Ahorro / Parafiscales Tradicionales) × 100"

       - **Supuestos y Restricciones** section:
         - "Los bonos de flexibilidad salarial NO generan parafiscales"
         - "El porcentaje mínimo de salario es 60% de la compensación total"
         - "Se utilizan tasas oficiales de parafiscales colombianos vigentes"
         - "El cálculo no incluye prestaciones sociales (prima, cesantías)"

    Use Tailwind for styling: bg-white, rounded-lg, shadow, p-6
  </action>
  <verify>
    - TypeScript compiles without errors
    - Component expands/collapses on button click
    - All rates display correctly
    - Formulas are clear and readable
    - Assumptions are comprehensive
  </verify>
  <done>CalculationDetails component complete and functional</done>
</task>

<task type="auto">
  <name>Task 2: Integrate details into comparison view and enhance existing components</name>
  <files>components/ComparisonView.tsx, app/page.tsx</files>
  <action>
    Update ComparisonView:
    - Import CalculationDetails component
    - Add CalculationDetails below the scenario cards grid
    - Pass arlRiskLevel prop to CalculationDetails

    Minor enhancements to existing components (VIZ-01, VIZ-02, VIZ-03):
    - Ensure ComparisonView title emphasizes comparison: "Comparación de Escenarios"
    - Ensure SavingsMetrics prominently displays total savings and percentage
    - Verify all existing visual hierarchy is clear

    No changes needed to page.tsx (ComparisonView already integrated).
  </action>
  <verify>
    - npm run build succeeds
    - CalculationDetails appears in ComparisonView
    - Expand/collapse functionality works
    - All existing components still render correctly
    - Page layout remains clean and organized
  </verify>
  <done>Calculation details integrated, existing components enhanced</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] CalculationDetails expands/collapses correctly
- [ ] All rates, formulas, and assumptions display
- [ ] Integration with ComparisonView is seamless
- [ ] Existing components (comparison, metrics) still work
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- VIZ-12, VIZ-13, VIZ-14, VIZ-15 requirements satisfied
- Minor enhancements to VIZ-01, VIZ-02, VIZ-03 complete
- Professional transparency builds client trust
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/02-results-visualization/02-03-SUMMARY.md`
</output>
